#!/bin/bash

# SPDX-License-Identifier: MIT
# SPDX-FileCopyrightText: Copyright (c) 2021-2025 Chris Dragan

set -euo pipefail

UNAME=$(uname -s)

NOSTDLIB_TARGET=default

case "$UNAME" in
    Linux)                JOBS=$(grep -c ^processor /proc/cpuinfo) ;;
    Darwin)               JOBS=$(sysctl -n hw.ncpu) ;;
    CYGWIN*|MINGW*|MSYS*) JOBS="$NUMBER_OF_PROCESSORS"
                          # On Windows, disable tests when building without stdlib
                          NOSTDLIB_TARGET=build
                          ;;
    *)                    JOBS=2 ;;
esac

echo "Using $JOBS jobs, arch: $(uname -m)"

run()
{
    echo "$$ $@"
    "$@"
}

run rm -rf Out

run make -j $JOBS -k debug=0 $NOSTDLIB_TARGET

run make -j $JOBS -k debug=1 $NOSTDLIB_TARGET

run make -j $JOBS -k debug=1 stdlib=1
